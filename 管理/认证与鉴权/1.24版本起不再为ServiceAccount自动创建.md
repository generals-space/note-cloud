#

参考文章

1. [How to create ServiceAccount Secret in Kubernetes 1.24](https://medium.com/@gowthamshankar09/how-to-create-serviceaccount-secret-in-kubernetes-1-24-36a61bdb73ad)
2. [Kubernetes: KSA must now create secret/token manually as of Kubernetes 1.24](https://fabianlee.org/2022/10/16/kubernetes-ksa-must-now-create-secret-token-manually-as-of-kubernetes-1-24/)

## 描述

1.23及之前的版本中, 每创建一个 ServiceAccount, 就会自动为其创建一个 `service-account-token`类型的 Secret.

```console
$ kubectl create ns hjl-test01
namespace/hjl-test01 created
$ kubectl get sa -n hjl-test01
NAME      SECRETS   AGE
default   1         13s
$ kubectl get secret -n hjl-test01
NAME                  TYPE                                  DATA   AGE
default-token-h92lz   kubernetes.io/service-account-token   3      18s
```

但是从 1.24 开始, 不会再有这个服务了. 创建一个 ServiceAccount, 其对应的 Secret 就不再创建了.

```console
$ kubectl create ns hjl-test
namespace/hjl-test created

$ kubectl get sa -n hjl-test
NAME      SECRETS   AGE
default   0         6s

$ kubectl get secret -n hjl-test
No resources found in hjl-test namespace.
```

## 有什么影响?

按照参考文章1来说, 其实没什么影响. 因为 SA 的常规使用场景, 就是在 Pod 中通过`ServiceAccount`声明, 以及继承该 SA 对象的权限.

但是在 1.24 版本中, 虽然一个 SA 可能没有 Secret, 但是不影响 Pod 的引用. 在 Pod 创建时, 会为其引用的 SA 自动生成对应的 Secret(Pod 内部的`/run/secrets/kubernetes.io/serviceaccount/token`文件).

不过, 对于同一个 SA, 不同的 Pod 内部中生成的`token`文件内容是不同的. 每个 token 分为3段, 对其中第2段进行解析, 可能得到如下内容.

```
{"aud":["https://kubernetes.default.svc.cluster.local"],"exp":1704980839,"iat":1673444839,"iss":"https://kubernetes.default.svc.cluster.local","kubernetes.io":{"namespace":"test-ns","pod":{"name":"webhook-xxx","uid":"cd1108be-b3f4-466c-b638-31bf500c01d4"},"serviceaccount":{"name":"default","uid":"e9b4d519-7d3e-4925-a0b9-566618ab92a0"},"warnafter":1673448446},"nbf":1673444839,"sub":"system:serviceaccount:test-ns:default"}

{"aud":["https://kubernetes.default.svc.cluster.local"],"exp":1704980855,"iat":1673444855,"iss":"https://kubernetes.default.svc.cluster.local","kubernetes.io":{"namespace":"test-ns","pod":{"name":"webhook-yyy","uid":"2e8be0f4-e5f0-4294-afc0-69ca5a8d264f"},"serviceaccount":{"name":"default","uid":"e9b4d519-7d3e-4925-a0b9-566618ab92a0"},"warnafter":1673448462},"nbf":1673444855,"sub":"system:serviceaccount:test-ns:default"}
```

即, 这些 token 是表明了自己对应哪个 SA, 也包含自己属于哪个 Pod, 这些 pod 都可以获得该 SA 的权限.

## Pod创建时, 是谁自动生成并挂载的 token ?
