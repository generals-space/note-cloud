# coredns启动失败-[FATAL] plugin loop：Loop (127.0.0.1：60390 - ：53) detected for zone

参考文章

1. [Troubleshooting](https://coredns.io/plugins/loop/#troubleshooting)
    - 官方文档
2. [如何管理 Docker 容器和 Kubernetes Pod 的 DNS](https://zhuanlan.zhihu.com/p/652731859)
    - 从Docker 1.10开始，Docker提供了一个内置的DNS服务器,当创建的容器属于自定义网络时，容器的`/etc/resolv.conf`会使用内置的DNS服务器（地址永远是`127.0.0.11`）来解析相同自定义网络内的其他容器。
3. [CoreDNS 提示 [FATAL] plugin/loop: Loop (127.0.0.1:38759 -> :53) detected for zone](https://i4t.com/5634.html)
4. [CoreDNS Error：[FATAL] plugin/loop: Loop](https://blog.51cto.com/hexiaoshuai/2812394)

kube: 1.17.2

## 问题描述

基于kind-systemd镜像部署kube集群, 安装flannel后, coredns启动失败.

```log
$ kubectl get pod -A
NAMESPACE     NAME                       READY   STATUS             RESTARTS   AGE
kube-system   coredns-7f9c544f75-8nt4r   0/1     CrashLoopBackOff   1          12s
kube-system   coredns-7f9c544f75-b4t8k   0/1     CrashLoopBackOff   1          12s
```

```log
$ kubectl logs -f -n kube-system coredns-7f9c544f75-8nt4r
.:53
[INFO] plugin/reload: Running configuration MD5 = 4e235fcc3696966e76816bcd9034ebc7
CoreDNS-1.6.5
linux/amd64, go1.13.4, c2fd1b2
[FATAL] plugin/loop: Loop (127.0.0.1:60390 -> :53) detected for zone ".", see https://coredns.io/plugins/loop#troubleshooting. Query: "HINFO 4286371723284111342.7169196055063366999."
```

##

看参考文章中所说, coredns配置中有个`loop`插件, 不允许`/etc/resolve.conf`中存在本地回环地址. 因为除了集群内的域名, coredns需要将请求转发到上游DNS服务器, 如果存在本地地址, 则会将请求直接转发给自己.

查看容器内的`/etc/resolve.conf`配置如下

```ini
# Generated by Docker Engine.
# This file can be edited; Docker Engine will not make further changes once it
# has been modified.

nameserver 127.0.0.11
options ndots:0

# Based on host file: '/etc/resolv.conf' (internal resolver)
# ExtServers: [192.168.6.3]
# Overrides: []
# Option ndots from: internal
```

果然

> `127.0.0.11`是docker内置的dns服务器地址, kind-systemd使用了compose配置, 声明了`ipv4_address`与`aliases`.

## 解决方法

按照参考文章3中所说, 将`nameserver`设置为`114.114.114.114`(或是宿主机的`/etc/resolv.conf` nameserver 地址), 则无法查询到kube内部的域名了.

```log
$ kubectl -n kube-system get pod -owide
Unable to connect to the server: dial tcp: lookup kube-apiserver.generals.space on 192.168.6.3:53: no such host
```
